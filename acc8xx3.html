<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script type="text/javascript" src="MarcDialogs.js"></script>
<link type="text/css" rel="stylesheet" href="MarcDialogs.css" media="all"/>

<script type="text/javascript" src="https://unpkg.com/snarkdown@1.0.2/dist/snarkdown.umd.js"></script>


<style>
.accordion {
    background-color: #eee;
    color: #444;
    cursor: pointer;
    padding: 18px;
    width: 100%;
    border: 1px solid #7f8c8d;
    text-align: left;
    outline: none;
    font-size: 15px;
    transition: 0.4s;
}

.active, .accordion:hover {
    background-color: #ccc; 
}

.panel {
    padding: 0 18px;
    width: calc(100% - 36px);;
    display: none;
    background-color: #FFE0B2;
    overflow: hidden;
}

.memosp {
  float: right;
  display: none;
  margin: 5px 5px;
  padding: 5px 10px; 
  border-radius: 5px;
  background: #64FFDA;
}

#kenmei,#kenmeiins,#kenmeiupd,#kenmeishr {
  width: 90%;
  font-size: 1.5em;
} 

#memonameno,#memonamenoins,#memonamenoupd,#memonamenoshr {
  display: none;
}

#naiyoins,#naiyoupd {
  margin: 5px 0px;
  width: 90%;
  font-size: 1.5em;  
}

body {
  background: #FFFF8D;
}

h2 {
  margin: 5px;
}

.btnup {
  margin: 5px 0px;
  font-size: 1.2em;
}

.memomd {
  border: 1px solid #bdc3c7;
  background: #F8BBD0;
}


</style>

<script type="text/javascript">
    function doDataLink(data) {
        // alert(data);
        Android.dataLink(data);
    }
</script>



</head>
<body>

<h2>簡易メモ(ver0.4)</h2>
<button class="btnup" id="del">画面消去</button>
<button class="btnup" id="sai">再表示</button>
<button class="btnup" id="owari" onclick="doDataLink('//x//')">終了</button>

<div id="disparea">


</div>



<div id="dialog-custom1" class="dialog">
	件名画面<p>
	<label for="kenmei">メモの件名</label>
	<input type="text" id="kenmei" />
	<input type="text" id="memonameno" />
	
	<div class="buttons">
		<button onclick="kenupd()">変更</button>
		<button onclick="MarcDialogs.close()">中止</button>
	</div>
</div>


<div id="dialog-custom2" class="dialog">
	メモ追加画面<p>
	<label for="kenmei">メモの件名</label>
	<input type="text" id="kenmeiins" placeholder="メモの件名" />
	<textarea id="naiyoins" rows="15" placeholder="メモの内容" ></textarea>
	<input type="text" id="memonamenoins">
	
	<div class="buttons">
		<button onclick="insupd()">追加</button>
		<button onclick="insclr()">クリア</button>
		<button onclick="MarcDialogs.close()">中止</button>
	</div>
</div>

<div id="dialog-custom3" class="dialog">
	メモ更新画面<p>
	<label for="kenmei">メモの件名</label>
	<input type="text" id="kenmeiupd" placeholder="メモの件名" />
	<textarea id="naiyoupd" rows="15" placeholder="メモの内容" ></textarea>
	<input type="text" id="memonamenoupd">
	
	<div class="buttons">
		<button onclick="updupd()">更新</button>
		<button onclick="updclr()">クリア</button>
		<button onclick="MarcDialogs.close()">中止</button>
	</div>
</div>

<div id="dialog-custom4" class="dialog">
	DropBoxリンク追加<p>
	<label for="kenmei">共有名</label>
	<input type="text" id="kenmeishr" placeholder="共有リンクを貼付" />
	<input type="text" id="memonamenoshr" />
	
	<div class="buttons">
		<button onclick="shradd()">追加</button>
		<button onclick="MarcDialogs.close()">中止</button>
	</div>
</div>


<script>
// var anchors = new anchorJS();

var memoall = 
[{"memoname":"このツールについて","memo":"簡易メモはシンプルなメモ帳です"},
{"memoname":"件名ボタン","memo":"件名を更新します"},
{"memoname":"追加ボタン","memo":"メモを前後どちらかに追加します"},
{"memoname":"削除ボタン","memo":"メモを削除します"},
{"memoname":"更新ボタン","memo":"メモの件名と内容を更新します"}
];

var stokey = "kanimemokey20180402";
var str = window.localStorage.getItem(stokey);
if (str == null) {
  console.log("ローカルストレージにメモ情報なし");
} else {
  if (str == "") {
    console.log("ローカルストレージにメモ情報が空");
  } else {
    console.log("ローカルストレージよりメモ情報取得");
    memoall = JSON.parse(str);
  };
};

console.log(memoall);

credisp();

function credisp(){
// 表示用DOM生成処理　メモ全件で繰り返し

  for (var idx in memoall) {

    // console.log(memoall[idx].memoname);

    // メモの件名ボタン生成
    var btn = document.createElement("button");
    btn.setAttribute("id", "memoname"+idx);
    btn.setAttribute("class", "accordion");

    // メモの件名フィールド生成
    var spanmn = document.createElement("span");
    spanmn.setAttribute("id", "memonamesmn"+idx);
    spanmn.setAttribute("class", "memospmn");
    spanmn.innerHTML = memoall[idx].memoname;

    // メモの更新ボタン生成
    var spanupd = document.createElement("span");
    spanupd.setAttribute("id", "memonameupd"+idx);
    spanupd.setAttribute("class", "memosp");
    spanupd.innerHTML = "更新";

    // メモの削除ボタン生成
    var spandel = document.createElement("span");
    spandel.setAttribute("id", "memonamedel"+idx);
    spandel.setAttribute("class", "memosp");
    spandel.innerHTML = "削除";

    // メモの追加ボタン生成
    var spanins = document.createElement("span");
    spanins.setAttribute("id", "memonameins"+idx);
    spanins.setAttribute("class", "memosp");
    spanins.innerHTML = "追加";

    // メモの件名変更ボタン生成
    var spanken = document.createElement("span");
    spanken.setAttribute("id", "memonameken"+idx);
    spanken.setAttribute("class", "memosp");
    spanken.innerHTML = "件名";

    // メモのMDボタン生成
    var spanmdg = document.createElement("span");
    spanmdg.setAttribute("id", "memonamemdg"+idx);
    spanmdg.setAttribute("class", "memosp");
    spanmdg.innerHTML = "ＭＤ";

    // メモのDRボタン生成
    var spanshr = document.createElement("span");
    spanshr.setAttribute("id", "memonameshr"+idx);
    spanshr.setAttribute("class", "memosp");
    spanshr.innerHTML = "ＤＲ";



    // 改行生成
    var kaigyo = document.createElement("br");


    // メモ用全体エリア生成
    var div = document.createElement("div");
    div.setAttribute("id", "memo"+idx);
    div.setAttribute("class", "panel");

    // メモ用編集可能エリア生成
    var p = document.createElement("p");
    p.setAttribute("id", "memop"+idx);
    p.setAttribute("class", "memop");
    p.setAttribute("contentEditable", "true");
    var wk1 = memoall[idx].memo.replace(/\n/g,"<br>");


    // 画像ファイル抽出
    var testData = wk1;
    var wk2 = '';               

    var matches = testData.match(/http[s]?\:\/\/[\w\+\$\;\?\.\%\,\!\#\~\*\/\:\@\&\\\=\_\-]+/g);
    console.log(matches);
    if (matches == null) {
    } else {
      var res = new Array;
      wk2='<hr>';
      matches.forEach(function(val,index) {
      if(val != ''){
          var ptn = /.jpg|.png|.gif|.jpeg/i;
          if(ptn.test(val)){
              wk2 = wk2+'<img style=\"margin: 0px 10px;\" width=\"100\" src=\"' + val + '\">';    
          }
       }
      });

      console.log(res);

    }
    //

    p.innerHTML = wk1+wk2;

    // メモＭＤ表示エリア生成
    var md = document.createElement("div");
    md.setAttribute("id", "memomd"+idx);
    md.setAttribute("class", "memomd");
    //md.setAttribute("contentEditable", "true");
    md.innerHTML = "";


    // DOM定義設定
    document.getElementById("disparea").appendChild(btn);
    document.getElementById("memoname"+idx).appendChild(spanmn);
    document.getElementById("disparea").appendChild(spanshr);
    document.getElementById("disparea").appendChild(spanmdg);
    document.getElementById("disparea").appendChild(spanupd);
    document.getElementById("disparea").appendChild(spandel);
    document.getElementById("disparea").appendChild(spanins);
    document.getElementById("disparea").appendChild(spanken);
    document.getElementById("disparea").appendChild(kaigyo);
    document.getElementById("disparea").appendChild(div);
    document.getElementById("memo"+idx).appendChild(p);
    document.getElementById("memo"+idx).appendChild(md);

  };

  // 各ボタンのイベントリスナー設定
  addev();
}

function addev() {
// 各ボタンのイベントリスナー設定

  var acc = document.getElementsByClassName("accordion");
  var i;

  // メモの件名ボタンクリック時のイベントリスナ設定
  for (i = 0; i < acc.length; i++) {
      // console.log(acc[i]);
      acc[i].addEventListener("click", function() {
          this.classList.toggle("active");

          var spanshr = this.nextElementSibling;
          console.log(spanshr);
          if (spanshr.style.display === "block") {
              spanshr.style.display = "none";
          } else {
              spanshr.style.display = "block";
          };

          var spanmdg = spanshr.nextElementSibling;
          console.log(spanmdg);
          if (spanmdg.style.display === "block") {
              spanmdg.style.display = "none";
          } else {
              spanmdg.style.display = "block";
          };

          var spanupd = spanmdg.nextElementSibling;
          console.log(spanupd);
          if (spanupd.style.display === "block") {
              spanupd.style.display = "none";
          } else {
              spanupd.style.display = "block";
          };

          var spandel = spanupd.nextElementSibling;
          console.log(spandel);
          if (spandel.style.display === "block") {
              spandel.style.display = "none";
          } else {
              spandel.style.display = "block";
          };

          var spanins = spandel.nextElementSibling;
          console.log(spanins);
          if (spanins.style.display === "block") {
              spanins.style.display = "none";
          } else {
              spanins.style.display = "block";
          };

          var spanken = spanins.nextElementSibling;
          console.log(spanken);
          if (spanken.style.display === "block") {
              spanken.style.display = "none";
          } else {
              spanken.style.display = "block";
          }

          var kaigyo = spanken.nextElementSibling;
          console.log(kaigyo);
/*          if (kaigyo.style.display === "block") {
              kaigyo.style.display = "none";
          } else {
              kaigyo.style.display = "block";
          }
*/

          var panel = kaigyo.nextElementSibling;
          console.log(panel);
          if (panel.style.display === "block") {
              panel.style.display = "none";
          } else {
              panel.style.display = "block";
          };


      });

  }


  var memosp = document.getElementsByClassName("memosp");

  // 件名、追加、削除、更新ボタンクリック時のイベントリスナ設定
  for (i = 0; i < memosp.length; i++) {
      // console.log(memosp[i]);
      memosp[i].addEventListener("click", function() {
        console.log(this.id);
        console.log(this.id.slice(11));
        console.log(this.id.substr(0,11));
        var syurui = this.id.substr(0,11);
        var memono = Number(this.id.slice(11));
        switch( syurui ) {
            case 'memonameken':
　　　　　　　　ken(memono);
                break;
         
            case 'memonameins':
                ins(memono);
                break;

            case 'memonamedel':
                delmemo(memono);
                break;

            case 'memonameupd':
                updmemo(memono);
                break;

            case 'memonamemdg':
                mdgmemo(memono);
                break;

            case 'memonameshr':
                shrmemo(memono);
                break;


         
        }

      });

  };

}

function delall(){
// 表示エリアのDOM全削除

  var disparea = document.getElementById("disparea");
  while (disparea.firstChild) {
    disparea.removeChild(disparea.firstChild);
  }
  
}

function creall(){
// 表示エリアのDOM全削除→表示用DOM生成処理

  delall();
  credisp();  
}

function ken(memonoupd){
// 件名変更ダイアログ表示

  MarcDialogs.open('custom1');
  document.getElementById('kenmei').value = memoall[memonoupd].memoname;
  document.getElementById('memonameno').value = memonoupd;
  console.log('件名変更処理');
}

function shrmemo(memonoshr){
// ドロップボックス共有ダイアログ表示

  MarcDialogs.open('custom4');
  document.getElementById('kenmeishr').value = "";
  document.getElementById('memonamenoshr').value = memonoshr;
  console.log('ドロップボックス共有追加処理');
}



function ins(memonoins){
// メモ追加ダイアログ表示

  MarcDialogs.open('custom2');
  console.log(memonoins);
  document.getElementById('memonamenoins').value = memonoins;
  console.log('メモ追加処理');
}

function mdgmemo(memonomdg){
// MD処理
  if (document.getElementById('memomd'+memonomdg).innerHTML == "") {
    var motodata = document.getElementById('memop'+memonomdg).innerText;
    var wkmotodata = motodata.replace(/＜/g,"<");
    wkmotodata = wkmotodata.replace(/＞/g,">");

    // snarkdown.js呼出
    var mddata = snarkdown(wkmotodata);

    document.getElementById('memomd'+memonomdg).innerHTML = mddata;
  } else {
    document.getElementById('memomd'+memonomdg).innerHTML = "";
  };
  console.log('メモＭＤ処理');
}


function updmemo(memonoupdupd){
// メモ更新ダイアログ表示

  MarcDialogs.open('custom3');
  document.getElementById('kenmeiupd').value = memoall[memonoupdupd].memoname;
  document.getElementById('naiyoupd').value = memoall[memonoupdupd].memo;
  console.log(memonoupdupd);
  document.getElementById('memonamenoupd').value = memonoupdupd;
  console.log('メモ更新処理');
}



function delmemo(memonodel){
// メモ削除処理

  // 確認ダイアログの表示
  if(window.confirm('メモを削除しますか')){

    console.log('メモ削除OK');


  } else{

    console.log('メモ削除NG');
    return false;

  }

  // 作業用データ
  var outmemo = [];

  //　削除位置
  var delpos = memonodel;

  // 削除処理
  Object.keys(memoall).forEach(function(key){
    // console.log(key);
    console.log(memoall[key].memoname,memoall[key].memo);
    if (key == delpos) {
      console.log('削除実行');
    } else {
      outmemo.push({
        memoname: memoall[key].memoname,
        memo: memoall[key].memo
      });
    }
  });

  // 作業用データをコピー
  memoall = outmemo;

  creall();
  stoupd();
  MarcDialogs.alert('削除が完了しました');

}



function insclr(){
// メモ追加ダイアログクリア
  document.getElementById('kenmeiins').value = "";
  document.getElementById('naiyoins').value = "";
  console.log('メモ追加画面クリア処理');
}

function updclr(){
// メモ更新ダイアログクリア
  document.getElementById('kenmeiupd').value = "";
  document.getElementById('naiyoupd').value = "";
  console.log('メモ更新画面クリア処理');
}


function kenupd() {
// 件名更新処理

  var newmemoname = document.getElementById('kenmei').value;
  var updmemono = Number(document.getElementById('memonameno').value);
　MarcDialogs.close()

　var wknewmemoname = newmemoname.replace(/</g,"＜");
　wknewmemoname = wknewmemoname.replace(/>/g,"＞");

  memoall[updmemono].memoname = wknewmemoname;

  creall();
  stoupd();

  MarcDialogs.alert('更新が完了しました');
}


function shradd() {
// ドロップボックス共有追加処理

  var addshrmemoname = document.getElementById('kenmeishr').value;
  var addshrmemono = Number(document.getElementById('memonamenoshr').value);
　MarcDialogs.close()

　var wkaddshrmemoname = generateDirectLink(addshrmemoname);
　wkaddshrmemoname = memoall[addshrmemono].memo+'\n\n[Dropbox画像]\n'+wkaddshrmemoname;

  memoall[addshrmemono].memo =wkaddshrmemoname;

  creall();
  stoupd();

  MarcDialogs.alert('共有を追加しました');
}


function insupd() {
// メモ追加処理

　var maeato = "ato";

  // 確認ダイアログの表示
  if(window.confirm('このメモの前に追加→キャンセル\n後に追加→OK')){

　　maeato = "ato";

  } else{

    maeato = "mae";

  }


  var newmemonameins = document.getElementById('kenmeiins').value;
  var newmemonoins = Number(document.getElementById('memonamenoins').value);
  var newnaiyoins = document.getElementById('naiyoins').value;
　MarcDialogs.close()
  console.log(newmemonameins);
  console.log(newmemonoins);
  console.log(newnaiyoins);

  // 作業用データ
  var outmemo = [];

  // 追加データ
　var wknewmemonameins = newmemonameins.replace(/</g,"＜");
　wknewmemonameins = wknewmemonameins.replace(/>/g,"＞");

　var wknewnaiyoins = newnaiyoins.replace(/</g,"＜");
　wknewnaiyoins = wknewnaiyoins.replace(/>/g,"＞");


  var tuikamemoname = wknewmemonameins;
  var tuikamemo = wknewnaiyoins;

  //　追加位置
  var tuikapos = newmemonoins;

  // オブジェクト化
  var tuika = {"memoname":tuikamemoname,"memo":tuikamemo};


  // 挿入処理
  Object.keys(memoall).forEach(function(key){
    // console.log(key);
    console.log(memoall[key].memoname,memoall[key].memo);
    if (key == tuikapos) {
      if (maeato == "ato") {
        outmemo.push({
          memoname: memoall[key].memoname,
          memo: memoall[key].memo
        });
        outmemo.push({
          memoname: tuika.memoname,
          memo: tuika.memo
        });
      } else {
        outmemo.push({
          memoname: tuika.memoname,
          memo: tuika.memo
        });
        outmemo.push({
          memoname: memoall[key].memoname,
          memo: memoall[key].memo
        });
      } 
    } else {
      outmemo.push({
        memoname: memoall[key].memoname,
        memo: memoall[key].memo
      });
    }
  });

  // 作業用データをコピー
  memoall = outmemo;

  creall();
  stoupd();

  MarcDialogs.alert('追加が完了しました');
}


function updupd() {
// メモ更新処理

  var newmemonameupd = document.getElementById('kenmeiupd').value;
  var newmemonoupd = Number(document.getElementById('memonamenoupd').value);
  var newnaiyoupd = document.getElementById('naiyoupd').value;
　MarcDialogs.close()
  console.log(newmemonameupd);
  console.log(newmemonoupd);
  console.log(newnaiyoupd);

　var wknewmemonameupd = newmemonameupd.replace(/</g,"＜");
　wknewmemonameupd = wknewmemonameupd.replace(/>/g,"＞");

　var wknewnaiyoupd = newnaiyoupd.replace(/</g,"＜");
　wknewnaiyoupd = wknewnaiyoupd.replace(/>/g,"＞");


  memoall[newmemonoupd].memoname = wknewmemonameupd;
  memoall[newmemonoupd].memo = wknewnaiyoupd;

  creall();
  stoupd();

  MarcDialogs.alert('更新が完了しました');
}

function stoupd() {
// ローカルストレージ更新

  var json_text = JSON.stringify(memoall);
  window.localStorage.setItem(stokey , json_text);
  doDataLink('//u//'+json_text);
}


function generateDirectLink(url) {
//　ドロップボックス画像リンク生成
  var parts = url.split('.');
  parts[0] = 'https://dl';
  parts[1] = 'dropboxusercontent';
  parts[parts.length - 1] = parts[parts.length - 1].slice(0,parts[parts.length - 1].length - 5);
  var ret = '';
  for (var i = 0; i < parts.length; i++) {
      ret = ret.concat(parts[i]);
      if (i != parts.length - 1) ret = ret + '.';
  }
  return ret;
};

// 画面消去、再表示ボタンの処理
var del = document.getElementById("del");
var sai = document.getElementById("sai");

del.addEventListener( "click" , delall , false );
sai.addEventListener( "click" , creall , false );



</script>

</body>
</html>
